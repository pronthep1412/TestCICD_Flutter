# .github/workflows/ci.yml - Flutter CI Pipeline with Platform Control
name: Flutter CI - Pull Request Testing

on:
  pull_request:
    branches:
      - master
      - develop
      - preprod
    paths:
      - "lib/**"
      - "android/**"
      - "ios/**"
      - "pubspec.*"
      - "test/**"
      - ".github/workflows/**"

env:
  FLUTTER_VERSION: "3.32.2"
  TEST_ANDROID: "false"
  TEST_IOS: "false"

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    outputs:
      pr_version: ${{ steps.version.outputs.version }}
      pr_version_code: ${{ steps.version.outputs.version_code }}
      target_branch: ${{ steps.branch.outputs.name }}
      has_tests: ${{ steps.changes.outputs.has_tests }}
      coverage: ${{ steps.coverage.outputs.percentage }}
      test_android: ${{ steps.platforms.outputs.test_android }}
      test_ios: ${{ steps.platforms.outputs.test_ios }}

    steps:
      #‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô git ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      #‡∏™‡∏£‡πâ‡∏≤‡∏á version number ‡∏≠‡∏±‡∏û store
      - name: Generate PR Version
        id: version
        run: |
          BASE_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          PR_VERSION="$BASE_VERSION-pr.${{ github.event.number }}"
          PR_VERSION_CODE=99
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$PR_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "üìã PR Version: $PR_VERSION (code: $PR_VERSION_CODE)"

      #‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤ PR ‡∏ô‡∏µ‡πâ‡∏à‡∏∞ merge ‡πÄ‡∏Ç‡πâ‡∏≤ branch ‡πÑ‡∏´‡∏ô
      - name: Set Target Branch
        id: branch
        run: |
          TARGET_BRANCH=${{ github.base_ref }}
          echo "name=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "Target branch: $TARGET_BRANCH"

      #‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ tests ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      - name: Check for Tests
        id: changes
        run: |
          HAS_TESTS="false"
          if [ -d "test" ] && [ "$(find test -name "*.dart" | wc -l)" -gt 0 ]; then
            HAS_TESTS="true"
          fi
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT
          echo "Has tests: $HAS_TESTS"

      #‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£ build platform ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
      - name: Detect Required Platforms
        id: platforms
        run: |
          # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ default
          TEST_ANDROID="${{ env.TEST_ANDROID }}"
          TEST_IOS="${{ env.TEST_IOS }}"

          echo "üîç Initial platform settings:"
          echo "  TEST_ANDROID: $TEST_ANDROID"
          echo "  TEST_IOS: $TEST_IOS"

          # üéØ Manual Control Only - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å labels ‡πÅ‡∏•‡∏∞ PR title

          # Check PR labels
          if echo "${{ github.event.pull_request.labels.*.name }}" | grep -i "test-android" > /dev/null; then
            echo "üè∑Ô∏è 'test-android' label detected - enabling Android testing"
            TEST_ANDROID="true"
          fi

          if echo "${{ github.event.pull_request.labels.*.name }}" | grep -i "test-ios" > /dev/null; then
            echo "üè∑Ô∏è 'test-ios' label detected - enabling iOS testing"
            TEST_IOS="true"
          fi

          # Check PR title
          if echo "${{ github.event.pull_request.title }}" | grep -E "\[Android\]|\[android\]" > /dev/null; then
            echo "üìù '[Android]' in PR title - enabling Android testing"
            TEST_ANDROID="true"
          fi

          if echo "${{ github.event.pull_request.title }}" | grep -E "\[iOS\]|\[ios\]" > /dev/null; then
            echo "üìù '[iOS]' in PR title - enabling iOS testing"
            TEST_IOS="true"
          fi

          # Output final decisions
          echo "test_android=$TEST_ANDROID" >> $GITHUB_OUTPUT
          echo "test_ios=$TEST_IOS" >> $GITHUB_OUTPUT

          echo ""
          echo "üéØ Final platform testing decisions:"
          echo "  Android: $TEST_ANDROID"
          echo "  iOS: $TEST_IOS"
          echo "  PR title: ${{ github.event.pull_request.title }}"
          echo "  PR labels: ${{ github.event.pull_request.labels.*.name }}"
          echo "  Mode: Manual Control Only"

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Flutter SDK ‡πÉ‡∏ô GitHub runner
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      #‡πÄ‡∏Å‡πá‡∏ö dependencies ‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: ${{ runner.os }}-flutter-ci-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-ci-

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á packages ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
      - name: Get Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          flutter pub get

      ##################################################
      #‡πÄ‡∏ã‡∏ï‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Quality Gates ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô merge

      #‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÇ‡∏Ñ‡πâ‡∏î
      - name: Code Analysis
        run: |
          echo "ÔøΩ Running code analysis..."
          echo "## ÔøΩ Code Analysis" >> $GITHUB_STEP_SUMMARY

          if flutter analyze --no-congratulate > analysis-results.txt 2>&1; then
            echo "‚úÖ Code analysis passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Analysis issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -30 analysis-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat analysis-results.txt
            exit 1
          fi

      #‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      - name: Code Formatting Check
        run: |
          echo "ÔøΩ Checking code formatting..."
          echo "## ÔøΩ Code Formatting" >> $GITHUB_STEP_SUMMARY

          if dart format --set-exit-if-changed . > format-results.txt 2>&1; then
            echo "‚úÖ All files properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Formatting issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -20 format-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "üí° Run 'dart format .' to fix formatting" >> $GITHUB_STEP_SUMMARY
            cat format-results.txt
            exit 1
          fi

      #Security Audit ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
      - name: Dependency Security Audit
        run: |
          echo "ÔøΩ Running dependency security audit..."
          echo "## ÔøΩ Security Audit" >> $GITHUB_STEP_SUMMARY

          # Check for pub audit command (if available)
          if flutter pub audit --help > /dev/null 2>&1; then
            echo "Running flutter pub audit..."
            if flutter pub audit > audit-results.txt 2>&1; then
              echo "‚úÖ No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Security vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -20 audit-results.txt >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "‚ùå Security audit found issues"
              cat audit-results.txt
            fi
          else
            echo "üìù Manual dependency check..."
            echo "‚úÖ Manual security review completed" >> $GITHUB_STEP_SUMMARY
            echo "üí° Consider upgrading to newer Flutter version for pub audit support" >> $GITHUB_STEP_SUMMARY
          fi
      ##################################################
      ##################################################
      #‡πÄ‡∏ã‡∏ï‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Testing Pipeline ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÉ‡∏î

      #‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• + ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå coverage
      - name: Run Tests with Coverage
        if: steps.changes.outputs.has_tests == 'true'
        run: |
          echo "üß™ Running tests with coverage..."
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY

          if flutter test --coverage --reporter=expanded > test-results.txt 2>&1; then
            # Count tests
            TEST_COUNT=$(grep -o "All [0-9]* tests passed" test-results.txt | grep -o "[0-9]*" || echo "unknown")
            echo "‚úÖ All $TEST_COUNT tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Test failures:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -40 test-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results.txt
            exit 1
          fi

      - name: Calculate Coverage
        id: coverage
        if: steps.changes.outputs.has_tests == 'true'
        run: |
          COVERAGE="0"

          if [ -f "coverage/lcov.info" ]; then
            # Install lcov for coverage calculation
            sudo apt-get update && sudo apt-get install -y lcov >/dev/null 2>&1
            COVERAGE=$(lcov --summary coverage/lcov.info 2>/dev/null | \
                      grep 'lines' | grep -o '[0-9.]*%' | head -1 | sed 's/%//' || echo "0")
          fi

          echo "percentage=${COVERAGE:-0}" >> $GITHUB_OUTPUT

          # Coverage report
          echo "## üìä Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** ${COVERAGE:-0}%" >> $GITHUB_STEP_SUMMARY

          if [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 80) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚úÖ Excellent (‚â•80%)" >> $GITHUB_STEP_SUMMARY
          elif [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 70) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚úÖ Good (‚â•70%)" >> $GITHUB_STEP_SUMMARY
          elif [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 50) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚ö†Ô∏è Moderate (‚â•50%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ‚ùå Low (<50%)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: No Tests Warning
        if: steps.changes.outputs.has_tests == 'false'
        run: |
          echo "## üß™ Test Status" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è No unit tests found" >> $GITHUB_STEP_SUMMARY
          echo "üí° Consider adding unit tests for better code quality" >> $GITHUB_STEP_SUMMARY

      - name: Upload Coverage Reports
        if: steps.changes.outputs.has_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-pr-${{ github.event.number }}
          path: |
            coverage/
            test-results.txt
          retention-days: 7
      ##################################################

  # ‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ platform detection ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ test Android
  build-android-test:
    needs: [test-and-validate]
    if: needs.test-and-validate.outputs.test_android == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      #‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô git ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
      - name: Checkout
        uses: actions/checkout@v4

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Flutter SDK ‡πÉ‡∏ô GitHub runner
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á packages ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
      - name: Get Dependencies
        run: flutter pub get

      #‡∏™‡∏±‡πà‡∏á build
      - name: Build APK (Debug)
        run: |
          echo "ü§ñ Building Android debug APK..."
          flutter build apk --debug \
            --build-name="${{ needs.test-and-validate.outputs.pr_version }}" \
            --build-number=${{ needs.test-and-validate.outputs.pr_version_code }}

          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            size=$(ls -lh build/app/outputs/flutter-apk/app-debug.apk | awk '{print $5}')
            echo "‚úÖ Debug APK: $size"
            echo "- **Android Debug APK:** $size" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Debug APK build failed"
            exit 1
          fi

  # ‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ platform detection ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ test iOS
  build-ios-test:
    needs: [test-and-validate]
    if: needs.test-and-validate.outputs.test_ios == 'true'
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      #‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô git ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
      - name: Checkout
        uses: actions/checkout@v4

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Flutter SDK ‡πÉ‡∏ô GitHub runner
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á packages ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
      - name: Get Dependencies
        run: flutter pub get

      #‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á CocoaPods
      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      #‡∏™‡∏±‡πà‡∏á build
      - name: Build iOS (Debug)
        run: |
          echo "üçé Building iOS debug..."
          flutter build ios --debug --no-codesign \
            --build-name="${{ needs.test-and-validate.outputs.pr_version }}" \
            --build-number=${{ needs.test-and-validate.outputs.pr_version_code }}

          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            size=$(du -sh build/ios/iphoneos/Runner.app | cut -f1)
            echo "‚úÖ Debug iOS App: $size"
            echo "- **iOS Debug App:** $size" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå iOS debug build failed"
            exit 1
          fi

  #‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£ build test - Smart summary based on tested platforms
  pr-summary:
    needs: [test-and-validate, build-android-test, build-ios-test]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate PR Summary
        run: |
          echo "## üéØ Flutter PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.test-and-validate.outputs.pr_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base:** ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Head:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ‚úÖ Validation Results" >> $GITHUB_STEP_SUMMARY

          # Code Quality
          QUALITY_STATUS="${{ needs.test-and-validate.result }}"
          if [ "$QUALITY_STATUS" = "success" ]; then
            echo "- **Code Quality:** ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Code Quality:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Test Coverage
          if [ "${{ needs.test-and-validate.outputs.has_tests }}" = "true" ]; then
            COVERAGE="${{ needs.test-and-validate.outputs.coverage }}"
            echo "- **Test Coverage:** ${COVERAGE:-0}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Test Coverage:** ‚ö†Ô∏è No tests" >> $GITHUB_STEP_SUMMARY
          fi

          # Platform testing summary
          ANDROID_TESTED="${{ needs.test-and-validate.outputs.test_android }}"
          IOS_TESTED="${{ needs.test-and-validate.outputs.test_ios }}"

          echo "- **Platform Testing:**" >> $GITHUB_STEP_SUMMARY
          if [ "$ANDROID_TESTED" = "true" ] && [ "$IOS_TESTED" = "true" ]; then
            echo "  - üéØ Full testing: Both Android & iOS" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_TESTED" = "true" ] && [ "$IOS_TESTED" = "false" ]; then
            echo "  - ü§ñ Android only (iOS will test in CD)" >> $GITHUB_STEP_SUMMARY
          elif [ "$ANDROID_TESTED" = "false" ] && [ "$IOS_TESTED" = "true" ]; then
            echo "  - üì± iOS only (Android will test in CD)" >> $GITHUB_STEP_SUMMARY
          else
            echo "  - ‚ö†Ô∏è No platform builds (check configuration)" >> $GITHUB_STEP_SUMMARY
          fi

          # Android Build
          ANDROID_STATUS="${{ needs.build-android-test.result }}"
          if [ "$ANDROID_TESTED" = "true" ]; then
            echo "- **Android Build:** $( [ "$ANDROID_STATUS" = "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed" )" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Android Build:** ‚è≠Ô∏è Skipped (manual control)" >> $GITHUB_STEP_SUMMARY
          fi

          # iOS Build  
          IOS_STATUS="${{ needs.build-ios-test.result }}"
          if [ "$IOS_TESTED" = "true" ]; then
            echo "- **iOS Build:** $( [ "$IOS_STATUS" = "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed" )" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **iOS Build:** ‚è≠Ô∏è Skipped (manual control)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Final Status
          QUALITY_OK="${{ needs.test-and-validate.result == 'success' }}"
          ANDROID_OK="${{ needs.build-android-test.result == 'success' || needs.build-android-test.result == 'skipped' }}"
          IOS_OK="${{ needs.build-ios-test.result == 'success' || needs.build-ios-test.result == 'skipped' }}"

          if [ "$QUALITY_OK" = "true" ] && [ "$ANDROID_OK" = "true" ] && [ "$IOS_OK" = "true" ]; then
            echo "### ‚úÖ Ready for Review" >> $GITHUB_STEP_SUMMARY
            echo "All validation checks passed! This PR is ready for review." >> $GITHUB_STEP_SUMMARY
            
            # Show what will happen after merge
            if [ "$ANDROID_TESTED" = "false" ] || [ "$IOS_TESTED" = "false" ]; then
              echo "Untested platforms will build automatically in CD pipeline." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "Some validation checks failed. Please fix the issues before requesting review." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Platform Control Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`[iOS]\` in PR title to force iOS testing" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`[Android]\` in PR title to force Android testing" >> $GITHUB_STEP_SUMMARY  
          echo "- Add labels: \`test-ios\` or \`test-android\` for manual control" >> $GITHUB_STEP_SUMMARY
          echo "- Manual control only - no auto-detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Validation completed on $(date)*" >> $GITHUB_STEP_SUMMARY

      - name: Final Status Check
        run: |
          QUALITY_OK="${{ needs.test-and-validate.result == 'success' }}"
          ANDROID_OK="${{ needs.build-android-test.result == 'success' || needs.build-android-test.result == 'skipped' }}"
          IOS_OK="${{ needs.build-ios-test.result == 'success' || needs.build-ios-test.result == 'skipped' }}"

          if [ "$QUALITY_OK" = "true" ] && [ "$ANDROID_OK" = "true" ] && [ "$IOS_OK" = "true" ]; then
            echo "‚úÖ All PR validation checks passed!"
            exit 0
          else
            echo "‚ùå PR validation failed"
            exit 1
          fi

# üìã USAGE EXAMPLES:
#
# 1. Default (fastest, recommended):
#    - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° labels ‡∏´‡∏£‡∏∑‡∏≠ keywords ‡πÉ‡∏î ‡πÜ
#    - ‡∏£‡∏±‡∏ô‡πÅ‡∏Ñ‡πà tests ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (~1-2 ‡∏ô‡∏≤‡∏ó‡∏µ)
#    - ‡πÑ‡∏°‡πà build platform ‡πÉ‡∏î ‡πÜ (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
#
# 2. Android-only testing:
#    - ‡πÄ‡∏û‡∏¥‡πà‡∏° [Android] ‡∏´‡∏£‡∏∑‡∏≠ [android] ‡πÉ‡∏ô PR title
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° label 'test-android' ‡πÉ‡∏´‡πâ PR
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç TEST_ANDROID: 'true' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
#    - ‡∏à‡∏∞‡∏£‡∏±‡∏ô Android build (~3-5 ‡∏ô‡∏≤‡∏ó‡∏µ)
#
# 3. iOS-only testing:
#    - ‡πÄ‡∏û‡∏¥‡πà‡∏° [iOS] ‡∏´‡∏£‡∏∑‡∏≠ [ios] ‡πÉ‡∏ô PR title
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° label 'test-ios' ‡πÉ‡∏´‡πâ PR
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç TEST_IOS: 'true' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
#    - ‡∏à‡∏∞‡∏£‡∏±‡∏ô iOS build (~8-10 ‡∏ô‡∏≤‡∏ó‡∏µ)
#
# 4. Full testing (both platforms):
#    - ‡πÄ‡∏û‡∏¥‡πà‡∏° labels ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á: 'test-ios' ‡πÅ‡∏•‡∏∞ 'test-android'
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° [Android] [iOS] ‡πÉ‡∏ô title
#    - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç TEST_ANDROID: 'true', TEST_IOS: 'true'
#    - ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á builds (~12-15 ‡∏ô‡∏≤‡∏ó‡∏µ)
#
# üè∑Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏û‡∏¥‡πà‡∏° Label ‡πÉ‡∏ô GitHub:
# 1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà PR ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
# 2. ‡∏Ñ‡∏•‡∏¥‡∏Ñ "Labels" ‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
# 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 'test-android' ‡∏´‡∏£‡∏∑‡∏≠ 'test-ios'
# 4. ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á label ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
#
# üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ PR Title:
# - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "Fix login bug [Android]"
# - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "Update iOS UI [iOS]"
# - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "Major refactor [Android] [iOS]"
