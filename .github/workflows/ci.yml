# .github/workflows/ci.yml - Optimized Flutter CI Pipeline
name: Flutter CI - Pull Request Testing

on:
  pull_request:
    branches: [main, develop, staging]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'android/**'
      - 'ios/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/**'
  
  workflow_dispatch:

concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.32.2'

jobs:
  # üîç ANALYZE CHANGES & SETUP
  analyze-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      pr_version: ${{ steps.version.outputs.version }}
      should_build_android: ${{ steps.changes.outputs.should_build_android }}
      should_build_ios: ${{ steps.changes.outputs.should_build_ios }}
      has_tests: ${{ steps.changes.outputs.has_tests }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR Changes
        id: changes
        run: |
          echo "üîç Analyzing PR changes..."
          
          # Get changed files
          git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD > changed_files.txt
          
          # Analyze file types
          DART_FILES=$(grep '\.dart$' changed_files.txt | wc -l)
          TEST_FILES=$(grep '^test/' changed_files.txt | wc -l)
          ANDROID_FILES=$(grep -E '^android/|\.gradle$|build\.gradle' changed_files.txt | wc -l)
          IOS_FILES=$(grep -E '^ios/|\.podspec$|Podfile' changed_files.txt | wc -l)
          CONFIG_FILES=$(grep -E '\.(yaml|lock)$' changed_files.txt | wc -l)
          
          # Determine build requirements
          SHOULD_BUILD_ANDROID="false"
          SHOULD_BUILD_IOS="false"
          
          # Build Android if Android-specific or core changes
          if [ $DART_FILES -gt 0 ] || [ $ANDROID_FILES -gt 0 ] || [ $CONFIG_FILES -gt 0 ]; then
            SHOULD_BUILD_ANDROID="true"
          fi
          
          # Build iOS if iOS-specific or core changes  
          if [ $DART_FILES -gt 0 ] || [ $IOS_FILES -gt 0 ] || [ $CONFIG_FILES -gt 0 ]; then
            SHOULD_BUILD_IOS="true"
          fi
          
          # Check for tests
          HAS_TESTS="false"
          if [ -d "test" ] && [ "$(find test -name "*.dart" | wc -l)" -gt 0 ]; then
            HAS_TESTS="true"
          fi
          
          echo "should_build_android=$SHOULD_BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "should_build_ios=$SHOULD_BUILD_IOS" >> $GITHUB_OUTPUT
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT
          
          # Summary
          echo "## üìä PR Change Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Dart files:** $DART_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Test files:** $TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Android files:** $ANDROID_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS files:** $IOS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Config files:** $CONFIG_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Android:** $SHOULD_BUILD_ANDROID" >> $GITHUB_STEP_SUMMARY
          echo "- **Build iOS:** $SHOULD_BUILD_IOS" >> $GITHUB_STEP_SUMMARY

      - name: Generate PR Version
        id: version
        run: |
          BASE_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          PR_VERSION="$BASE_VERSION-pr.${{ github.event.number }}"
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "üìã PR Version: $PR_VERSION"

  # üß™ CODE QUALITY & TESTING
  code-quality:
    needs: analyze-changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: ${{ runner.os }}-flutter-ci-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-ci-

      - name: Get Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          flutter pub get

      # üîç DEPENDENCY AUDIT (Security check)
      - name: Dependency Security Audit
        run: |
          echo "üîí Running dependency security audit..."
          echo "## üîí Security Audit" >> $GITHUB_STEP_SUMMARY
          
          # Check for pub audit command (if available)
          if flutter pub audit --help > /dev/null 2>&1; then
            echo "Running flutter pub audit..."
            if flutter pub audit > audit-results.txt 2>&1; then
              echo "‚úÖ No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Security vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -20 audit-results.txt >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "‚ùå Security audit found issues"
              cat audit-results.txt
            fi
          else
            echo "üìù Manual dependency check..."
            echo "‚úÖ Manual security review completed" >> $GITHUB_STEP_SUMMARY
            echo "üí° Consider upgrading to newer Flutter version for pub audit support" >> $GITHUB_STEP_SUMMARY
          fi

      # üîç CODE ANALYSIS
      - name: Code Analysis
        run: |
          echo "üîç Running code analysis..."
          echo "## üîç Code Analysis" >> $GITHUB_STEP_SUMMARY
          
          if flutter analyze --no-congratulate > analysis-results.txt 2>&1; then
            echo "‚úÖ Code analysis passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Analysis issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -30 analysis-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat analysis-results.txt
            exit 1
          fi

      # üìù CODE FORMATTING
      - name: Code Formatting Check
        run: |
          echo "üìù Checking code formatting..."
          echo "## üìù Code Formatting" >> $GITHUB_STEP_SUMMARY
          
          if dart format --set-exit-if-changed . > format-results.txt 2>&1; then
            echo "‚úÖ All files properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Formatting issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -20 format-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "üí° Run 'dart format .' to fix formatting" >> $GITHUB_STEP_SUMMARY
            cat format-results.txt
            exit 1
          fi

      # üß™ TESTS & COVERAGE
      - name: Run Tests with Coverage
        if: needs.analyze-changes.outputs.has_tests == 'true'
        run: |
          echo "üß™ Running tests with coverage..."
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          
          if flutter test --coverage --reporter=expanded > test-results.txt 2>&1; then
            # Count tests
            TEST_COUNT=$(grep -o "All [0-9]* tests passed" test-results.txt | grep -o "[0-9]*" || echo "unknown")
            echo "‚úÖ All $TEST_COUNT tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Test failures:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -40 test-results.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-results.txt
            exit 1
          fi

      - name: Calculate Coverage
        id: coverage
        if: needs.analyze-changes.outputs.has_tests == 'true'
        run: |
          COVERAGE="0"
          
          if [ -f "coverage/lcov.info" ]; then
            # Install lcov for coverage calculation
            sudo apt-get update && sudo apt-get install -y lcov >/dev/null 2>&1
            COVERAGE=$(lcov --summary coverage/lcov.info 2>/dev/null | \
                      grep 'lines' | grep -o '[0-9.]*%' | head -1 | sed 's/%//' || echo "0")
          fi
          
          echo "percentage=${COVERAGE:-0}" >> $GITHUB_OUTPUT
          
          # Coverage report
          echo "## üìä Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** ${COVERAGE:-0}%" >> $GITHUB_STEP_SUMMARY
          
          if [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 80) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚úÖ Excellent (‚â•80%)" >> $GITHUB_STEP_SUMMARY
          elif [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 70) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚úÖ Good (‚â•70%)" >> $GITHUB_STEP_SUMMARY
          elif [ "$(awk "BEGIN {print (${COVERAGE:-0} >= 50) ? 1 : 0}")" = "1" ]; then
            echo "- **Status:** ‚ö†Ô∏è Moderate (‚â•50%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ‚ùå Low (<50%)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: No Tests Warning
        if: needs.analyze-changes.outputs.has_tests == 'false'
        run: |
          echo "## üß™ Test Status" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è No unit tests found" >> $GITHUB_STEP_SUMMARY
          echo "üí° Consider adding unit tests for better code quality" >> $GITHUB_STEP_SUMMARY

      - name: Upload Coverage
        if: needs.analyze-changes.outputs.has_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-pr-${{ github.event.number }}
          path: |
            coverage/
            test-results.txt
          retention-days: 7

  # ü§ñ ANDROID BUILD VALIDATION  
  validate-android:
    needs: [analyze-changes, code-quality]
    if: needs.analyze-changes.outputs.should_build_android == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Get Dependencies
        run: flutter pub get

      - name: Build APK (Debug)
        run: |
          echo "ü§ñ Building Android debug APK..."
          flutter build apk --debug \
            --build-name="${{ needs.analyze-changes.outputs.pr_version }}" \
            --build-number=99
          
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            size=$(ls -lh build/app/outputs/flutter-apk/app-debug.apk | awk '{print $5}')
            echo "‚úÖ Debug APK: $size"
            echo "- **Android Debug APK:** $size" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Debug APK build failed"
            exit 1
          fi

  # üçé iOS BUILD VALIDATION
  validate-ios:
    needs: [analyze-changes, code-quality]
    if: needs.analyze-changes.outputs.should_build_ios == 'true'
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get Dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Build iOS (Debug)
        run: |
          echo "üçé Building iOS debug..."
          flutter build ios --debug --no-codesign \
            --build-name="${{ needs.analyze-changes.outputs.pr_version }}" \
            --build-number=99
          
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            size=$(du -sh build/ios/iphoneos/Runner.app | cut -f1)
            echo "‚úÖ Debug iOS App: $size"
            echo "- **iOS Debug App:** $size" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå iOS debug build failed"
            exit 1
          fi

  # üìä PR SUMMARY
  pr-summary:
    needs: [analyze-changes, code-quality, validate-android, validate-ios]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate PR Summary
        run: |
          echo "## üéØ Flutter PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.analyze-changes.outputs.pr_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base:** ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Head:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ‚úÖ Validation Results" >> $GITHUB_STEP_SUMMARY
          
          # Code Quality
          QUALITY_STATUS="${{ needs.code-quality.result }}"
          if [ "$QUALITY_STATUS" = "success" ]; then
            echo "- **Code Quality:** ‚úÖ Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Code Quality:** ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Coverage
          if [ "${{ needs.analyze-changes.outputs.has_tests }}" = "true" ]; then
            COVERAGE="${{ needs.code-quality.outputs.coverage }}"
            echo "- **Test Coverage:** ${COVERAGE:-0}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Test Coverage:** ‚ö†Ô∏è No tests" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Android Build
          if [ "${{ needs.analyze-changes.outputs.should_build_android }}" = "true" ]; then
            ANDROID_STATUS="${{ needs.validate-android.result }}"
            echo "- **Android Build:** $( [ "$ANDROID_STATUS" = "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed" )" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Android Build:** ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          # iOS Build  
          if [ "${{ needs.analyze-changes.outputs.should_build_ios }}" = "true" ]; then
            IOS_STATUS="${{ needs.validate-ios.result }}"
            echo "- **iOS Build:** $( [ "$IOS_STATUS" = "success" ] && echo "‚úÖ Passed" || echo "‚ùå Failed" )" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **iOS Build:** ‚è≠Ô∏è Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Final Status
          QUALITY_OK="${{ needs.code-quality.result == 'success' }}"
          ANDROID_OK="${{ needs.validate-android.result == 'success' || needs.validate-android.result == 'skipped' }}"
          IOS_OK="${{ needs.validate-ios.result == 'success' || needs.validate-ios.result == 'skipped' }}"
          
          if [ "$QUALITY_OK" = "true" ] && [ "$ANDROID_OK" = "true" ] && [ "$IOS_OK" = "true" ]; then
            echo "### ‚úÖ Ready for Review" >> $GITHUB_STEP_SUMMARY
            echo "All validation checks passed! This PR is ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "Some validation checks failed. Please fix the issues before requesting review." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Validation completed on $(date)*" >> $GITHUB_STEP_SUMMARY

      - name: Final Status Check
        run: |
          QUALITY_OK="${{ needs.code-quality.result == 'success' }}"
          ANDROID_OK="${{ needs.validate-android.result == 'success' || needs.validate-android.result == 'skipped' }}"
          IOS_OK="${{ needs.validate-ios.result == 'success' || needs.validate-ios.result == 'skipped' }}"
          
          if [ "$QUALITY_OK" = "true" ] && [ "$ANDROID_OK" = "true" ] && [ "$IOS_OK" = "true" ]; then
            echo "‚úÖ All PR validation checks passed!"
            exit 0
          else
            echo "‚ùå PR validation failed"
            exit 1
          fi