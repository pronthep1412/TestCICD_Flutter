# .github/workflows/ios-reusable.yml - Updated with API key content support
name: iOS Build & Deploy

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      version_code:
        required: true
        type: string
      branch:
        required: true
        type: string
      environment:
        required: false
        type: string
        default: 'development'
    secrets:
      APP_STORE_CONNECT_API_KEY_ID:
        required: true
      APP_STORE_CONNECT_API_ISSUER_ID:
        required: true
      APP_STORE_CONNECT_API_KEY:
        required: true
      MATCH_PASSWORD:
        required: true
      MATCH_GIT_URL:
        required: true
      MATCH_PRIVATE_KEY:
        required: true
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.2.3)'
        required: true
        default: '1.0.0'
      version_code:
        description: 'Version code (e.g., 123)'
        required: true
        default: '1'
      branch:
        description: 'Branch name'
        required: true
        default: 'develop'
      environment:
        description: 'Environment'
        required: false
        default: 'development'

env:
  FLUTTER_VERSION: '3.32.2'

jobs:
  build-and-deploy-ios:
    runs-on: macos-15
    environment: ${{ inputs.environment }}
    
    steps:
      #à¸”à¸¶à¸‡à¹‚à¸„à¹‰à¸”à¹ƒà¸™ git à¸¡à¸²à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ 
      - name: Checkout
        uses: actions/checkout@v4

      #à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Flutter SDK à¹ƒà¸™ GitHub runner
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      #à¹€à¸à¹‡à¸š dependencies à¸—à¸µà¹ˆà¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§à¹„à¸§à¹‰à¹ƒà¸Šà¹‰à¸‹à¹‰à¸³
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.gradle/wrapper
            ~/.gradle/caches
            ~/Library/Caches/CocoaPods
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-flutter-ios-${{ hashFiles('pubspec.lock', 'ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-ios-

      #à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ packages à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¹ƒà¸™à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ
      - name: Get Dependencies
        run: |
          echo "ðŸ“¦ Installing Flutter dependencies..."
          flutter pub get
          echo "âœ… Flutter dependencies installed"

      #à¸­à¸±à¸žà¹€à¸”à¸—à¹€à¸¥à¸‚à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸‚à¸­à¸‡à¹à¸­à¸›
      - name: Update Version
        run: |
          echo "ðŸ“ Updating version to: ${{ inputs.version }}+${{ inputs.version_code }}"
          sed -i '' "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.version_code }}/" pubspec.yaml
          grep "^version:" pubspec.yaml
          echo "âœ… Version updated in pubspec.yaml"

      #à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² SSH authentication à¹€à¸žà¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡ Match repository
      - name: Setup SSH for Match
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.MATCH_PRIVATE_KEY }}

      #log à¹€à¸­à¸²à¹„à¸§à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š API keys
      - name: Verify App Store Connect API Configuration
        run: |
          echo "ðŸ”‘ Verifying App Store Connect API configuration..."
          
          # Check if all required API variables are available
          if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" ]; then
            echo "âœ… API Key ID: Available"
          else
            echo "âŒ API Key ID: Missing"
          fi
          
          if [ -n "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" ]; then
            echo "âœ… Issuer ID: Available"
          else
            echo "âŒ Issuer ID: Missing"
          fi
          
          if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY }}" ]; then
            # Check if it's valid base64
            if echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > /dev/null 2>&1; then
              echo "âœ… API Key Content: Available and valid base64"
              decoded_length=$(echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d | wc -c | tr -d ' ')
              echo "   Decoded length: $decoded_length characters"
            else
              echo "âŒ API Key Content: Invalid base64 format"
            fi
          else
            echo "âŒ API Key Content: Missing"
          fi

      #à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ CocoaPods
      - name: Install CocoaPods Dependencies
        run: |
          echo "ðŸ“± Installing CocoaPods dependencies..."
          cd ios
          
          # Check if cache hit
          if [ -d "Pods" ] && [ -f "Podfile.lock" ]; then
            echo "âœ… Pods cache found, verifying integrity..."
            pod install --deployment 2>/dev/null || {
              echo "âš ï¸ Cache invalid, reinstalling..."
              rm -rf Pods Podfile.lock
              pod install
            }
          else
            echo "ðŸ”„ Installing fresh Pods..."
            pod install
          fi
          
          echo "âœ… CocoaPods installation completed"

      #à¹€à¸•à¸£à¸µà¸¢à¸¡ Ruby environment à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ Fastlane
      - name: Setup Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      #à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ IPA à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸‚à¸¶à¹‰à¸™ App Store Connect
      - name: Build and Deploy iOS
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          FL_UPDATE_PLIST_PATH: Runner/Info.plist
          VERSION_NAME: ${{ inputs.version }}
          VERSION_CODE: ${{ inputs.version_code }}
        run: |
          echo "ðŸŽ Building and deploying iOS..."
          
          # Show version information for debugging
          echo "ðŸ“‹ Version Information:"
          echo "- VERSION_NAME: $VERSION_NAME"
          echo "- VERSION_CODE: $VERSION_CODE"
          echo "- Input Version: ${{ inputs.version }}"
          echo "- Input Version Code: ${{ inputs.version_code }}"
          
          # Determine deployment target and lane based on branch
          case "${{ inputs.branch }}" in
            "master") 
              TARGET="app_store"
              LANE="deploy_master"
              echo "ðŸª Target: App Store"
              ;;
            "preprod") 
              TARGET="testflight_beta"
              LANE="deploy_preprod"
              echo "âœˆï¸ Target: TestFlight Beta"
              ;;
            *) 
              TARGET="testflight_internal"
              LANE="deploy_develop"
              echo "ðŸ”’ Target: TestFlight Internal"
              ;;
          esac
          
          # Pre-build validation
          echo "ðŸ“‹ Build configuration:"
          echo "- Target: $TARGET"
          echo "- Lane: $LANE"
          echo "- Version: ${{ inputs.version }}"
          echo "- Build: ${{ inputs.version_code }}"
          echo "- Branch: ${{ inputs.branch }}"
          echo "- API Key ID: ${APP_STORE_CONNECT_API_KEY_ID:0:8}..."
          echo "- API Key Content: $([ -n "$APP_STORE_CONNECT_API_KEY_CONTENT" ] && echo "Available" || echo "Missing")"
          
          # Deploy with Fastlane using standardized lane names
          cd ios
          
          echo "ðŸš€ Starting deployment..."
          bundle exec fastlane $LANE
          
          echo "âœ… iOS deployment completed!"

      #à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² build à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸ˆà¸£à¸´à¸‡à¹† à¹à¸¥à¸°à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£
      - name: Verify Build Artifacts
        run: |
          echo "ðŸ” Verifying build artifacts..."
          
          # Check for IPA file
          if find ios -name "*.ipa" -type f | head -1 | read ipa_file; then
            echo "âœ… IPA found: $ipa_file"
            ipa_size=$(ls -lh "$ipa_file" | awk '{print $5}')
            echo "   Size: $ipa_size"
          else
            echo "âš ï¸ No IPA file found (may be normal for direct upload)"
          fi
          
          # Check Fastlane logs
          if [ -d "ios/fastlane/logs" ]; then
            echo "ðŸ“‹ Fastlane logs available"
            ls -la ios/fastlane/logs/
          fi
          
          # Check build directory
          if [ -d "ios/build" ]; then
            echo "ðŸ“¦ Build directory contents:"
            ls -la ios/build/
          fi
      
      #à¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œ build results à¹„à¸§à¹‰à¹ƒà¸™ GitHub à¸ªà¸³à¸«à¸£à¸±à¸š download à¸«à¸£à¸·à¸­ debug
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ inputs.version }}-${{ github.run_number }}
          path: |
            ios/build/
            ios/fastlane/logs/
            ios/*.ipa
          retention-days: 30

      #à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£ build 
      - name: Build Summary
        run: |
          echo "## ðŸŽ iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ inputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** ${{ runner.os }} ($(sw_vers -productVersion))" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter:** ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          
          # Show deployment target
          case "${{ inputs.branch }}" in
            "master") echo "- **Target:** ðŸª App Store" >> $GITHUB_STEP_SUMMARY ;;
            "preprod") echo "- **Target:** âœˆï¸ TestFlight Beta" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "- **Target:** ðŸ”’ TestFlight Internal" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          # Check for IPA and show size
          if find ios -name "*.ipa" -type f | head -1 | read ipa_file; then
            size=$(ls -lh "$ipa_file" | awk '{print $5}')
            echo "- **IPA Size:** $size" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Performance metrics
          if [ -f "ios/fastlane/logs/"*.log ]; then
            echo "- **Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Build Status:** âš ï¸ Check logs" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Build completed on $(date)*" >> $GITHUB_STEP_SUMMARY

      #à¸¥à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸±à¸š à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸ build/deploy à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          # âœ… à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ cleanup API key file à¹à¸¥à¹‰à¸§à¹€à¸žà¸£à¸²à¸°à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸ªà¸£à¹‰à¸²à¸‡
          # SSH keys are cleaned up automatically by ssh-agent action
          
          # Clean up any temporary build files
          rm -rf ios/build/temp 2>/dev/null || true
          rm -rf ios/fastlane/tmp 2>/dev/null || true
          
          echo "âœ… Cleanup completed"