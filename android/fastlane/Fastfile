# android/fastlane/Fastfile - Static Android Fastlane Configuration
default_platform(:android)

platform :android do

  #Setup และ Configuration
  before_all do
    ENV["FASTLANE_SKIP_UPDATE_CHECK"] = "1"
    setup_ci if ENV['CI']
  end

  #Deploy ขึ้น store
  desc "Deploy to Google Play Store"
  lane :deploy do |options|
    track = options[:track] || "internal"
    
    UI.message("🚀 Deploying Android to Google Play")
    UI.message("📍 Track: #{track}")
    UI.message("📦 Current directory: #{Dir.pwd}")
    
    # 🔍 Look for AAB file in multiple locations
    possible_paths = [
      "../build/app/outputs/bundle/release/app-release.aab",
      "../../build/app/outputs/bundle/release/app-release.aab",
      "../app/build/outputs/bundle/release/app-release.aab"
    ]
    
    aab_path = nil
    possible_paths.each do |path|
      abs_path = File.expand_path(path)
      if File.exist?(abs_path)
        aab_path = abs_path
        UI.message("✅ Found AAB at: #{aab_path}")
        break
      end
    end
    
    unless aab_path
      UI.user_error!("❌ AAB file not found in any expected location")
    end
    
    aab_size = File.size(aab_path) / 1024.0 / 1024.0
    UI.message("📏 AAB size: #{aab_size.round(2)} MB")
    
    # Upload to Google Play Store
    upload_to_play_store(
      track: track,
      aab: aab_path,
      json_key: "google-play-key.json",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: track == "production" ? "completed" : "draft"
    )
    
    UI.success("✅ Successfully deployed to #{track} track!")
  end
  
  #สำหรับ Deployment Google play
  desc "Deploy to production (master branch)"
  lane :deploy_production do
    deploy(track: "production")
  end
  
  #สำหรับ Deployment Google play beta
  desc "Deploy to beta (preprod branch)"
  lane :deploy_beta do
    deploy(track: "beta")
  end
  
  #สำหรับ Deployment Google play internal
  desc "Deploy to internal (develop branch)"
  lane :deploy_internal do
    deploy(track: "internal")
  end
  
  #สำหรับ Build แต่ไม่ deploy
  desc "Build only (no deploy)"
  lane :build_only do
    gradle(task: "clean assembleRelease")
    UI.success("✅ Android build completed!")
  end
  
  #Error handling
  error do |lane, exception|
    UI.error("❌ Error in #{lane}: #{exception.message}")
    
    # Upload logs for debugging
    if ENV['CI']
      UI.message("📋 Fastlane logs available in artifacts")
    end
  end
end